# Dockerfile for building AWS Lambda deployment package
# This Dockerfile uses the same base image as AWS Lambda runtime to ensure
# complete compatibility and avoid glibc version mismatches

# Use Amazon Linux 2 base image - same as AWS Lambda runtime environment
FROM --platform=linux/amd64 amazonlinux:2

# Install Rust and required system dependencies
RUN yum update -y && yum install -y \
    # Development tools for building Rust projects
    gcc \
    gcc-c++ \
    make \
    # ZIP utility for creating deployment packages
    zip \
    unzip \
    # Additional tools for debugging and validation
    file \
    # Git for Rust toolchain installation
    git \
    # curl for downloading Rust installer
    curl \
    # Clean up yum cache to reduce image size
    && yum clean all

# Install Rust using rustup (official installer)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.83.0
ENV PATH="/root/.cargo/bin:${PATH}"

# Verify Rust installation and add target (native compilation, no cross-compilation needed)
RUN rustc --version && cargo --version

# Set working directory
WORKDIR /usr/src/app

# Create a build script that will be used as the default command
RUN printf '#!/bin/bash\nset -euo pipefail\n\necho "ðŸ¦€ Building Rust Lambda function for AWS deployment..."\necho "Rust version: $(rustc --version)"\necho "Cargo version: $(cargo --version)"\necho "Target: x86_64-unknown-linux-gnu (native compilation)"\necho "OS: $(cat /etc/os-release | grep PRETTY_NAME)"\necho ""\n\n# Handle Cargo.lock version compatibility\nif ! cargo build --release 2>/dev/null; then\n    echo "âš ï¸  Cargo.lock version mismatch detected, regenerating..."\n    rm -f Cargo.lock\n    echo "ðŸ“¦ Building project with regenerated Cargo.lock..."\n    cargo build --release\nelse\n    echo "ðŸ“¦ Building project..."\nfi\n\n# Verify the binary was created\nBINARY_PATH="target/release/static-web-lambda"\nif [[ ! -f "$BINARY_PATH" ]]; then\n    echo "âŒ Error: Binary not found at $BINARY_PATH"\n    exit 1\nfi\n\necho "âœ… Build completed successfully!"\necho "Binary location: $BINARY_PATH"\necho "Binary size: $(stat -c%%s "$BINARY_PATH") bytes"\necho "Binary type: $(file "$BINARY_PATH")"\necho "Binary dependencies:"\nldd "$BINARY_PATH" || echo "Static binary (no dynamic dependencies)"\n\n# Create deployment package\necho ""\necho "ðŸ“¦ Creating deployment package..."\nmkdir -p lambda-package\ncp "$BINARY_PATH" lambda-package/bootstrap\nchmod +x lambda-package/bootstrap\n\n# Create ZIP file\ncd lambda-package\nzip -r ../lambda-deployment.zip bootstrap\ncd ..\n\necho "âœ… Deployment package created: lambda-deployment.zip"\necho "Package size: $(stat -c%%s lambda-deployment.zip) bytes"\necho "Package contents:"\nunzip -l lambda-deployment.zip\n' > /usr/local/bin/build-lambda.sh && chmod +x /usr/local/bin/build-lambda.sh

# Default command runs the build script
CMD ["/usr/local/bin/build-lambda.sh"]

# Labels for documentation and maintenance
LABEL maintainer="Static Web Lambda Project"
LABEL description="Build environment for Rust AWS Lambda functions using Amazon Linux 2"
LABEL version="1.0"
LABEL rust.version="1.83"
LABEL base.image="amazonlinux:2"
LABEL target="x86_64-unknown-linux-gnu"